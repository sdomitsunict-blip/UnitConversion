<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単位変換ツール</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: linear-gradient(to bottom, #000000, #aaaaaa);
            color: #f4f4f4;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background-color: #333333;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        h1, h2 {
            text-align: center;
            color: #ffffff;
        }
        .section {
            border-top: 2px solid #555;
            padding-top: 20px;
            margin-top: 20px;
        }
        .formula-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .formula-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .formula-group .katex-display {
            margin: 0 10px;
            color: #ffffff;
        }
        .formula-group p {
            margin: 0;
            font-size: 0.9em;
            color: #ccc;
        }
        .input-group, .output-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            justify-content: center;
        }
        .input-group label, .output-group label {
            width: 120px;
            font-weight: bold;
            color: #ccc;
        }
        .input-group input, .input-group select, .output-group select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: #fff;
        }
        .input-group input {
            text-align: right;
            font-size: 1.2em;
        }
        .input-group select {
            font-size: 1.2em;
        }
        .result-table select {
            background-color: #444;
            color: #fff;
            border: 1px solid #555;
            padding: 5px;
            font-size: 1.0em;
        }
        .result-table select option {
            background-color: #444;
            color: #fff;
        }
        .slider-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .slider-group input[type="range"] {
            flex-grow: 1;
            margin-right: 10px;
            -webkit-appearance: none;
            height: 8px;
            background: #555;
            border-radius: 5px;
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #ffffff;
            border-radius: 50%;
            cursor: pointer;
        }
        .radio-group {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .radio-group label {
            margin: 0 15px;
            font-weight: bold;
            color: #ccc;
        }
        .radio-group input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
            position: relative;
            top: -1px;
            outline: none;
            cursor: pointer;
        }
        .radio-group input[type="radio"]:checked {
            background-color: #ffffff;
            border-color: #ffffff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #555;
        }
        th {
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        td {
            color: #f4f4f4;
        }
        .result-table td:nth-child(1) {
            text-align: center;
            padding-left: 0;
        }
        .result-table td:not(:nth-child(1)) {
            text-align: left;
            padding-left: 20px;
        }
        .tabs-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #555;
        }
        .tab-button {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #ccc;
            transition: color 0.3s;
        }
        .tab-button.active {
            color: #fff;
            border-bottom: 2px solid #fff;
        }
        .tab-content {
            display: none;
            padding-top: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .graph-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .graph-input-group label {
            width: 100px;
            font-weight: bold;
            color: #ccc;
        }
        .graph-input-group input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: #fff;
            text-align: right;
            font-size: 1.0em;
        }
        .graph-input-group select {
            width: 80px;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #444;
            color: #fff;
        }
        .graph-button {
            display: block;
            margin: 0 auto;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #555;
            color: #fff;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs-container">
        <button class="tab-button active" data-tab="tab1">周波数・波長・波数</button>
        <button class="tab-button" data-tab="tab2">複素屈折率・複素誘電率</button>
        <button class="tab-button" data-tab="tab3">線膨張率</button>
    </div>

    <div id="tab1" class="tab-content active">
        <h1>周波数・波長・波数 変換ツール</h1>

        <div class="formula-container">
            <div class="formula-group">
                $$ E = hf $$
                <p>$E$: エネルギー, $h$: プランク定数</p>
            </div>
            <div class="formula-group">
                $$f = \frac{c}{\lambda} = c\tilde{\nu}$$
                <p>$f$: 周波数, $\lambda$: 波長, $\tilde{\nu}$: 波数, $c$: 光速</p>
            </div>
            <div class="formula-group">
                $$\lambda = \frac{c}{f} = \frac{1}{\tilde{\nu}}$$
            </div>
            <div class="formula-group">
                $$\tilde{\nu} = \frac{f}{c} = \frac{1}{\lambda}$$
            </div>
        </div>

        <div class="section">
            <h2>単一値の計算</h2>
            <div class="radio-group">
                <label><input type="radio" name="input-type" value="f" checked> 周波数</label>
                <label><input type="radio" name="input-type" value="lambda"> 波長</label>
                <label><input type="radio" name="input-type" value="wavenumber"> 波数</label>
                <label><input type="radio" name="input-type" value="e"> エネルギー</label>
            </div>
            <div class="input-group">
                <label for="input-value">入力値:</label>
                <input type="number" id="input-value" step="any" placeholder="値を入力">
                <select id="input-scale"></select>
            </div>
            <div class="slider-group">
                <input type="range" id="input-slider" min="0" max="100" step="1">
                <span id="slider-value-display"></span>
            </div>

            <table class="result-table">
                <thead>
                    <tr>
                        <th>パラメータ</th>
                        <th>値</th>
                        <th>単位</th>
                    </tr>
                </thead>
                <tbody id="single-value-table-body">
                    <tr>
                        <td>周波数</td>
                        <td id="f-output-value"></td>
                        <td>
                            <select id="f-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>波長</td>
                        <td id="lambda-output-value"></td>
                        <td>
                            <select id="lambda-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>波数</td>
                        <td id="wavenumber-output-value"></td>
                        <td>
                            <select id="wavenumber-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>エネルギー</td>
                        <td id="e-output-value"></td>
                        <td>
                            <select id="e-output-scale"></select>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>範囲の計算</h2>
            <div class="radio-group">
                <label><input type="radio" name="range-type" value="f" checked> 周波数</label>
                <label><input type="radio" name="range-type" value="lambda"> 波長</label>
                <label><input type="radio" name="range-type" value="wavenumber"> 波数</label>
                <label><input type="radio" name="range-type" value="e"> エネルギー</label>
            </div>
            <div class="input-group">
                <label for="min-input">最小値:</label>
                <input type="number" id="min-input" step="any">
                <label for="max-input" style="margin-left: 10px;">最大値:</label>
                <input type="number" id="max-input" step="any">
                <select id="range-scale"></select>
            </div>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>パラメータ</th>
                        <th>最小値</th>
                        <th>最大値</th>
                        <th>単位</th>
                    </tr>
                </thead>
                <tbody id="range-table-body">
                    <tr>
                        <td>周波数</td>
                        <td id="range-f-min"></td>
                        <td id="range-f-max"></td>
                        <td>
                            <select id="range-f-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>波長</td>
                        <td id="range-lambda-min"></td>
                        <td id="range-lambda-max"></td>
                        <td>
                            <select id="range-lambda-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>波数</td>
                        <td id="range-wavenumber-min"></td>
                        <td id="range-wavenumber-max"></td>
                        <td>
                            <select id="range-wavenumber-output-scale"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>エネルギー</td>
                        <td id="range-e-min"></td>
                        <td id="range-e-max"></td>
                        <td>
                            <select id="range-e-output-scale"></select>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="tab2" class="tab-content">
        <h1>複素屈折率・複素誘電率 変換ツール</h1>

        <div class="formula-container">
            <div class="formula-group">
                $$ \tilde{n} = n + i\kappa, \quad \tilde{\epsilon} = \epsilon' + i\epsilon'' $$
                <p>$\tilde{n}$: 複素屈折率, $\tilde{\epsilon}$: 複素誘電率</p>
            </div>
            <div class="formula-group">
                $$ \tilde{\epsilon} = \tilde{n}^2 \implies \epsilon' = n^2 - \kappa^2, \quad \epsilon'' = 2n\kappa $$
            </div>
            <div class="formula-group">
                $$ n = \sqrt{\frac{\epsilon' + \sqrt{{\epsilon'}^2 + {\epsilon''}^2}}{2}}, \quad \kappa = \sqrt{\frac{-\epsilon' + \sqrt{{\epsilon'}^2 + {\epsilon''}^2}}{2}} $$
            </div>
            <div class="formula-group">
                $$ \tan\delta = \frac{\epsilon''}{\epsilon'}, \quad \tan\theta_B = n $$
            </div>
        </div>

        <div class="section">
            <h2>計算</h2>
            <div class="radio-group">
                <label><input type="radio" name="complex-input-type" value="n_k" checked> 複素屈折率 ($\tilde{n}$)</label>
                <label><input type="radio" name="complex-input-type" value="e_e"> 複素誘電率 ($\tilde{\epsilon}$)</label>
            </div>
            <div id="complex-input-n-k" style="display: flex; flex-direction: column; align-items: center;">
                <div class="input-group" style="width: 80%;">
                    <label for="n-input">屈折率 $n$:</label>
                    <input type="number" id="n-input" step="any" placeholder="実部" value="1.5">
                </div>
                <div class="input-group" style="width: 80%;">
                    <label for="k-input">消衰係数 $\kappa$:</label>
                    <input type="number" id="k-input" step="any" placeholder="虚部" value="0.01">
                </div>
            </div>
            <div id="complex-input-e-e" style="display: none; flex-direction: column; align-items: center;">
                <div class="input-group" style="width: 80%;">
                    <label for="e-real-input">誘電率実部 $\epsilon'$:</label>
                    <input type="number" id="e-real-input" step="any" placeholder="実部">
                </div>
                <div class="input-group" style="width: 80%;">
                    <label for="e-imag-input">誘電率虚部 $\epsilon''$:</label>
                    <input type="number" id="e-imag-input" step="any" placeholder="虚部">
                </div>
            </div>
            
            <table class="result-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">パラメータ</th>
                        <th style="text-align: center;">実部</th>
                        <th style="text-align: center;">虚部</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: center;">複素屈折率 $\tilde{n}$</td>
                        <td id="n-output-value" style="text-align: left; padding-left: 20px;"></td>
                        <td id="k-output-value" style="text-align: left; padding-left: 20px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: center;">複素誘電率 $\tilde{\epsilon}$</td>
                        <td id="e-real-output-value" style="text-align: left; padding-left: 20px;"></td>
                        <td id="e-imag-output-value" style="text-align: left; padding-left: 20px;"></td>
                    </tr>
                </tbody>
            </table>
            
            <table class="result-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th style="text-align: center;">パラメータ</th>
                        <th style="text-align: center;">値</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: center;">誘電正接 $\tan\delta$</td>
                        <td id="tandelta-output-value" style="text-align: left; padding-left: 20px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: center;">ブリュースター角 $\theta_B$</td>
                        <td id="brewster-output-value" style="text-align: left; padding-left: 20px;"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2 style="margin-bottom: 20px;">グラフ表示</h2>
            <div class="radio-group">
                <label><input type="radio" name="graph-x-axis" value="lambda" checked> 波長</label>
                <label><input type="radio" name="graph-x-axis" value="f"> 周波数</label>
            </div>
            <div class="graph-input-group">
                <label id="graph-x-axis-label">波長範囲:</label>
                <input type="number" id="min-x-axis-input" step="any">
                <span style="margin: 0 5px;">〜</span>
                <input type="number" id="max-x-axis-input" step="any">
                <select id="x-axis-scale"></select>
            </div>
            <div class="graph-input-group" style="justify-content: center;">
                <label for="y-axis-scale" style="width: 180px;">吸収係数 縦軸単位:</label>
                <select id="y-axis-scale" style="width: 80px;"></select>
            </div>
            <button id="update-graph-button" class="graph-button">グラフ更新</button>
            <div style="display: flex; justify-content: center; margin-bottom: 20px; margin-top: 20px;">
                <div style="width: 80%;">
                    <h3 style="text-align: center;">吸収係数 $\alpha = \frac{4\pi\kappa}{\lambda}$</h3>
                    <canvas id="absorptionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="tab3" class="tab-content">
        <h1>線膨張率 計算ツール (準備中)</h1>
        <p style="text-align: center; color: #aaa;">このツールは現在開発中です。</p>
    </div>

</div>

<script>
    // 物理定数
    const c = 299792458;
    const h = 6.62607015e-34;
    const eV_per_Joule = 6.241509074460763e18;
    const numPoints = 100;

    // データ保存
    let storedComplexValues = { n: 1.5, k: 0.01, eReal: 2.25, eImag: 0.03 };
    let storedGraphRange = {
        lambda: { min: 200, max: 1000, scale: 1e-9, unit: 'nm' },
        f: { min: 300, max: 1500, scale: 1e12, unit: 'THz' }
    };
    let absorptionChart;

    const colorCycle = [
        'rgb(75, 192, 192)', // Teal/Cyan
        'rgb(255, 99, 132)', // Red
        'rgb(255, 205, 86)', // Yellow
        'rgb(153, 102, 255)' // Purple
    ];


    const units = {
        // 周波数・波長・波数タブの単位定義 (省略せずに維持)
        f: {
            name: "周波数",
            default: "GHz",
            scales: [
                { value: 1e15, label: "PHz" }, { value: 1e12, label: "THz" },
                { value: 1e9, label: "GHz" }, { value: 1e6, label: "MHz" },
                { value: 1e3, label: "kHz" }, { value: 1e0, label: "Hz" },
                { value: 1e-3, label: "mHz" }, { value: 1e-6, label: "µHz" }
            ]
        },
        lambda: {
            name: "波長",
            default: "nm",
            scales: [
                { value: 1e9, label: "Gm" }, { value: 1e6, label: "Mm" },
                { value: 1e3, label: "km" }, { value: 1e0, label: "m" },
                { value: 1e-2, label: "cm" }, { value: 1e-3, label: "mm" },
                { value: 1e-6, label: "µm" }, { value: 1e-9, label: "nm" },
                { value: 1e-12, label: "pm" }, { value: 1e-15, label: "fm" }
            ]
        },
        wavenumber: {
            name: "波数",
            default: "cm⁻¹",
            scales: [
                { value: 1e-15, label: "Pm⁻¹" }, { value: 1e-12, label: "Tm⁻¹" },
                { value: 1e-9, label: "Gm⁻¹" }, { value: 1e-6, label: "Mm⁻¹" },
                { value: 1e-3, label: "km⁻¹" }, { value: 1e-2, label: "cm⁻¹" },
                { value: 1e0, label: "m⁻¹" }, { value: 1e3, label: "mm⁻¹" },
                { value: 1e6, label: "µm⁻¹" }, { value: 1e9, label: "nm⁻¹" }
            ]
        },
        e: {
            name: "エネルギー",
            default: "eV",
            scales: [
                { value: 1e-6, label: "µeV" }, { value: 1e-3, label: "meV" },
                { value: 1e0, label: "eV" }, { value: 1e3, label: "keV" },
                { value: 1e6, label: "MeV" }, { value: 1e9, label: "GeV" }
            ]
        },
        // 改善点2: 吸収係数の単位を追加
        alpha: {
            name: "吸収係数",
            default: "m⁻¹",
            scales: [
                { value: 1e0, label: "m⁻¹" },
                { value: 1e2, label: "cm⁻¹" } // 1 m^-1 = 100 cm^-1
            ]
        }
    };
    
    function populateScales(selectElement, unitType, defaultValue = null) {
        selectElement.innerHTML = '';
        units[unitType].scales.forEach(scale => {
            const option = document.createElement('option');
            option.value = scale.value;
            option.textContent = scale.label;
            if (defaultValue && scale.label === defaultValue) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    // 周波数・波長・波数タブのロジック (既存のロジックは省略)
    // ...

    // 複素屈折率・複素誘電率タブのDOM要素
    const complexInputTypeRadios = document.querySelectorAll('#tab2 input[name="complex-input-type"]');
    const nInput = document.getElementById('n-input');
    const kInput = document.getElementById('k-input');
    const eRealInput = document.getElementById('e-real-input');
    const eImagInput = document.getElementById('e-imag-input');
    const absorptionCtx = document.getElementById('absorptionChart').getContext('2d');
    const graphXAxisRadios = document.querySelectorAll('#tab2 input[name="graph-x-axis"]');
    const graphXAxisLabel = document.getElementById('graph-x-axis-label');
    const minXAxisInput = document.getElementById('min-x-axis-input');
    const maxXAxisInput = document.getElementById('max-x-axis-input');
    const xAxisScaleSelect = document.getElementById('x-axis-scale');
    const yAxisScaleSelect = document.getElementById('y-axis-scale'); // 縦軸単位の選択
    const updateGraphButton = document.getElementById('update-graph-button');


    function updateComplexInputs() {
        const type = document.querySelector('#tab2 input[name="complex-input-type"]:checked').value;
        const n_k_div = document.getElementById('complex-input-n-k');
        const e_e_div = document.getElementById('complex-input-e-e');

        n_k_div.style.display = type === 'n_k' ? 'flex' : 'none';
        e_e_div.style.display = type === 'e_e' ? 'flex' : 'none';
        
        // 入力値を保持した値を復元
        if (type === 'n_k') {
            nInput.value = storedComplexValues.n;
            kInput.value = storedComplexValues.k;
        } else {
            eRealInput.value = storedComplexValues.eReal;
            eImagInput.value = storedComplexValues.eImag;
        }

        calculateComplex();
    }

    function calculateComplex() {
        const type = document.querySelector('#tab2 input[name="complex-input-type"]:checked').value;
        let n, kappa, e_real, e_imag;
        let tan_delta, brewster_angle;

        if (type === 'n_k') {
            n = parseFloat(nInput.value);
            kappa = parseFloat(kInput.value);
            
            if (isNaN(n) || isNaN(kappa)) { clearComplexOutputs(); updateGraphs([]); return; }
            
            e_real = n*n - kappa*kappa;
            e_imag = 2*n*kappa;
            // 入力値を保持
            storedComplexValues.n = n;
            storedComplexValues.k = kappa;
        } else {
            e_real = parseFloat(eRealInput.value);
            e_imag = parseFloat(eImagInput.value);
            
            if (isNaN(e_real) || isNaN(e_imag)) { clearComplexOutputs(); updateGraphs([]); return; }
            
            const sqrt_term = Math.sqrt(e_real*e_real + e_imag*e_imag);
            n = Math.sqrt((e_real + sqrt_term)/2);
            kappa = Math.sqrt((-e_real + sqrt_term)/2);
            // 入力値を保持
            storedComplexValues.eReal = e_real;
            storedComplexValues.eImag = e_imag;
        }

        tan_delta = e_imag / e_real;
        brewster_angle = (Math.atan(n) * 180 / Math.PI);

        document.getElementById('n-output-value').textContent = n.toPrecision(7);
        document.getElementById('k-output-value').textContent = kappa.toPrecision(7);
        document.getElementById('e-real-output-value').textContent = e_real.toPrecision(7);
        document.getElementById('e-imag-output-value').textContent = e_imag.toPrecision(7);
        document.getElementById('tandelta-output-value').textContent = tan_delta.toPrecision(7);
        document.getElementById('brewster-output-value').textContent = brewster_angle.toPrecision(7) + '°';
        
        // 改善点3の土台：現在の計算結果をデータセットとしてグラフに渡す
        const currentDataset = [{ n: n, kappa: kappa, label: '現在の入力値' }];
        updateGraphs(currentDataset); 
    }
    
    function clearComplexOutputs() {
        document.getElementById('n-output-value').textContent = '';
        document.getElementById('k-output-value').textContent = '';
        document.getElementById('e-real-output-value').textContent = '';
        document.getElementById('e-imag-output-value').textContent = '';
        document.getElementById('tandelta-output-value').textContent = '';
        document.getElementById('brewster-output-value').textContent = '';
    }
    
    // 改善点1, 2の統合ロジック
    function updateGraphInputFields() {
        const xAxisType = document.querySelector('#tab2 input[name="graph-x-axis"]:checked').value;
        const currentRange = storedGraphRange[xAxisType];

        if (xAxisType === 'lambda') {
            graphXAxisLabel.textContent = '波長範囲:';
            populateScales(xAxisScaleSelect, 'lambda', currentRange.unit);
        } else { // 'f'
            graphXAxisLabel.textContent = '周波数範囲:';
            populateScales(xAxisScaleSelect, 'f', currentRange.unit);
        }

        // 保存された値を復元
        minXAxisInput.value = currentRange.min;
        maxXAxisInput.value = currentRange.max;
        
        // グラフを更新（現在の複雑な値を再計算）
        calculateComplex();
    }

    // 改善点1, 2, 3を統合したグラフ更新関数
    function updateGraphs(datasets) {
        const xAxisType = document.querySelector('#tab2 input[name="graph-x-axis"]:checked').value;
        const minVal = parseFloat(minXAxisInput.value);
        const maxVal = parseFloat(maxXAxisInput.value);
        const inputScale = parseFloat(xAxisScaleSelect.value);
        
        // 縦軸の単位スケールを取得
        const yScaleFactor = parseFloat(yAxisScaleSelect.value || 1);
        const yUnitLabel = yAxisScaleSelect.options[yAxisScaleSelect.selectedIndex]?.text || units.alpha.default;
        
        // 範囲の値を保存 (改善点2)
        const currentUnitLabel = xAxisScaleSelect.options[xAxisScaleSelect.selectedIndex].text;
        storedGraphRange[xAxisType] = { min: minVal, max: maxVal, scale: inputScale, unit: currentUnitLabel };

        if (!datasets || datasets.length === 0 || isNaN(minVal) || isNaN(maxVal) || minVal >= maxVal) {
            if (absorptionChart) {
                absorptionChart.destroy();
                absorptionChart = null;
            }
            return;
        }

        // 改善点3: 複数データセットの生成
        const chartDatasets = datasets.map((data, index) => {
            const kappa = data.kappa;
            const color = colorCycle[index % colorCycle.length];

            let xData = [];
            let yData = [];

            if (xAxisType === 'lambda') {
                const start_m = minVal * inputScale;
                const end_m = maxVal * inputScale;
                const step_m = (end_m - start_m) / numPoints;
                for (let i = 0; i <= numPoints; i++) {
                    const lambda_m = start_m + i * step_m;
                    if (lambda_m > 0) {
                        xData.push(lambda_m / inputScale); 
                        // alpha in m^-1, then scale to chosen unit
                        yData.push((4 * Math.PI * kappa) / lambda_m / yScaleFactor);
                    }
                }
            } else { // xAxisType === 'f'
                const start_f = minVal * inputScale;
                const end_f = maxVal * inputScale;
                const step_f = (end_f - start_f) / numPoints;
                for (let i = 0; i <= numPoints; i++) {
                    const f_hz = start_f + i * step_f;
                    if (f_hz > 0) {
                        const lambda_m = c / f_hz;
                        xData.push(f_hz / inputScale); 
                        // alpha in m^-1, then scale to chosen unit
                        yData.push((4 * Math.PI * kappa) / lambda_m / yScaleFactor);
                    }
                }
            }

            return {
                label: data.label || `データ ${index + 1} (κ=${kappa.toPrecision(3)})`,
                data: yData.map((y, i) => ({ x: xData[i], y: y })), 
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                parsing: false
            };
        });

        if (absorptionChart) {
            absorptionChart.destroy();
        }

        const xAxisTitle = (xAxisType === 'lambda') ? `波長 [${currentUnitLabel}]` : `周波数 [${currentUnitLabel}]`;
        // 改善点1: 縦軸のタイトルをプレーンテキストで修正
        const yAxisTitle = `吸収係数 alpha [${yUnitLabel}]`;

        // Y軸のmin/maxを全データセットから決定
        const allYData = chartDatasets.flatMap(ds => ds.data.map(p => p.y)).filter(y => y > 0);
        const yMin = allYData.length > 0 ? Math.min(...allYData) : 1e-1;
        const yMax = allYData.length > 0 ? Math.max(...allYData) : 1e10;

        Chart.defaults.color = '#fff';
        Chart.defaults.borderColor = '#555';
        absorptionChart = new Chart(absorptionCtx, {
            type: 'line',
            data: {
                datasets: chartDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: xAxisTitle },
                        min: minVal,
                        max: maxVal,
                        ticks: {
                            callback: (value) => value.toPrecision(3)
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        // 改善点1, 2: 縦軸タイトルと単位の反映
                        title: { display: true, text: yAxisTitle },
                        min: yMin * 0.5,
                        max: yMax * 2,
                        ticks: {
                            callback: function (value, index, values) {
                                if (value === 0) return null;
                                const logValue = Math.log10(value);
                                // 10^n と 2*10^n を表示
                                if (Math.abs(logValue % 1) < 1e-6 || Math.abs(logValue % 1 - Math.log10(2)) < 1e-6) {
                                    return value.toExponential(1);
                                }
                                return null;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            // ツールチップのラベルも選択された単位で表示
                            label: (context) => `吸収係数: ${context.parsed.y.toPrecision(4)} ${yUnitLabel}`,
                            title: (tooltipItems) => {
                                const val = tooltipItems[0].parsed.x * inputScale; 
                                let lambda_m, f_hz;

                                if (xAxisType === 'lambda') {
                                    lambda_m = val;
                                    f_hz = c / lambda_m;
                                } else {
                                    f_hz = val;
                                    lambda_m = c / f_hz;
                                }
                                
                                const lambda_nm = lambda_m * 1e9;
                                const f_thz = f_hz / 1e12;
                                
                                return `波長: ${lambda_nm.toFixed(2)} nm, 周波数: ${f_thz.toFixed(2)} THz`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 周波数・波長・波数タブの初期化 (前回のコードから再掲)
    const fTabInputTypeRadios = document.querySelectorAll('#tab1 input[name="input-type"]');
    const fTabInputValue = document.getElementById('input-value');
    const fTabInputScaleSelect = document.getElementById('input-scale');
    const fTabSlider = document.getElementById('input-slider');
    const fTabSliderValueDisplay = document.getElementById('slider-value-display');
    const fOutputSelect = document.getElementById('f-output-scale');
    const lambdaOutputSelect = document.getElementById('lambda-output-scale');
    const wavenumberOutputSelect = document.getElementById('wavenumber-output-scale');
    const eOutputSelect = document.getElementById('e-output-scale');
    const fTabMinInput = document.getElementById('min-input');
    const fTabMaxInput = document.getElementById('max-input');
    const fTabRangeTypeRadios = document.querySelectorAll('#tab1 input[name="range-type"]');
    const fTabRangeScaleSelect = document.getElementById('range-scale');
    const fTabRangeFOutputSelect = document.getElementById('range-f-output-scale');
    const fTabRangeLambdaOutputSelect = document.getElementById('range-lambda-output-scale');
    const fTabRangeWavenumberOutputSelect = document.getElementById('range-wavenumber-output-scale');
    const fTabRangeEOutputSelect = document.getElementById('range-e-output-scale');

    function updateSingleInputScales() {
        const selectedType = document.querySelector('#tab1 input[name="input-type"]:checked').value;
        populateScales(fTabInputScaleSelect, selectedType, units[selectedType].default);
        updateSliderRange();
        calculateSingleValue();
    }
    function updateSliderRange() {
        const value = parseFloat(fTabInputValue.value);
        if (!isNaN(value) && value !== 0) {
            fTabSlider.min = value / 2;
            fTabSlider.max = value * 2;
            fTabSlider.value = value;
            fTabSliderValueDisplay.textContent = value;
        }
    }
    function handleSliderInput() {
        fTabInputValue.value = fTabSlider.value;
        fTabSliderValueDisplay.textContent = fTabSlider.value;
        calculateSingleValue();
    }
    function calculateSingleValue() {
        const value = parseFloat(fTabInputValue.value);
        const unitType = document.querySelector('#tab1 input[name="input-type"]:checked').value;
        const inputScale = parseFloat(fTabInputScaleSelect.value);

        if (isNaN(value)) {
            document.getElementById('f-output-value').textContent = '';
            document.getElementById('lambda-output-value').textContent = '';
            document.getElementById('wavenumber-output-value').textContent = '';
            document.getElementById('e-output-value').textContent = '';
            return;
        }
        let baseValue;
        let f, lambda, wavenumber, e_joule;
        if (unitType === 'f') {
            baseValue = value * inputScale; f = baseValue; lambda = c / f; wavenumber = f / c; e_joule = h * f;
        } else if (unitType === 'lambda') {
            baseValue = value * inputScale; lambda = baseValue; f = c / lambda; wavenumber = f / c; e_joule = h * f;
        } else if (unitType === 'wavenumber') {
            baseValue = value * inputScale; wavenumber = baseValue; f = wavenumber * c; lambda = c / f; e_joule = h * f;
        } else {
            baseValue = value * inputScale; e_joule = baseValue / eV_per_Joule; f = e_joule / h; lambda = c / f; wavenumber = f / c;
        }
        document.getElementById('f-output-value').textContent = (f / parseFloat(fOutputSelect.value)).toPrecision(7);
        document.getElementById('lambda-output-value').textContent = (lambda / parseFloat(lambdaOutputSelect.value)).toPrecision(7);
        document.getElementById('wavenumber-output-value').textContent = (wavenumber / parseFloat(wavenumberOutputSelect.value)).toPrecision(7);
        document.getElementById('e-output-value').textContent = ((e_joule * eV_per_Joule) / parseFloat(eOutputSelect.value)).toPrecision(7);
    }
    function updateRangeInputScales() {
        const selectedType = document.querySelector('#tab1 input[name="range-type"]:checked').value;
        populateScales(fTabRangeScaleSelect, selectedType, units[selectedType].default);
        calculateRange();
    }
    function calculateRange() {
        const minVal = parseFloat(fTabMinInput.value);
        const maxVal = parseFloat(fTabMaxInput.value);
        const unitType = document.querySelector('#tab1 input[name="range-type"]:checked').value;
        const inputScale = parseFloat(fTabRangeScaleSelect.value);
        
        if (isNaN(minVal) || isNaN(maxVal)) {
            document.getElementById('range-f-min').textContent = ''; document.getElementById('range-f-max').textContent = '';
            document.getElementById('range-lambda-min').textContent = ''; document.getElementById('range-lambda-max').textContent = '';
            document.getElementById('range-wavenumber-min').textContent = ''; document.getElementById('range-wavenumber-max').textContent = '';
            document.getElementById('range-e-min').textContent = ''; document.getElementById('range-e-max').textContent = '';
            return;
        }
        
        let minBase = minVal * inputScale; let maxBase = maxVal * inputScale;
        let minF, maxF, minLambda, maxLambda, minWavenumber, maxWavenumber, minE_joule, maxE_joule;

        if (unitType === 'f') {
            minF = minBase; maxF = maxBase; minLambda = c / maxF; maxLambda = c / minF; minWavenumber = minF / c; maxWavenumber = maxF / c; minE_joule = h * minF; maxE_joule = h * maxF;
        } else if (unitType === 'lambda') {
            minLambda = minBase; maxLambda = maxBase; minF = c / maxLambda; maxF = c / minLambda; minWavenumber = 1 / maxLambda; maxWavenumber = 1 / minLambda; minE_joule = h * minF; maxE_joule = h * maxF;
        } else if (unitType === 'wavenumber') {
            minWavenumber = minBase; maxWavenumber = maxBase; minF = minWavenumber * c; maxF = maxWavenumber * c; minLambda = 1 / maxWavenumber; maxLambda = 1 / minWavenumber; minE_joule = h * minF; maxE_joule = h * maxF;
        } else {
            minE_joule = minBase / eV_per_Joule; maxE_joule = maxBase / eV_per_Joule; minF = minE_joule / h; maxF = maxE_joule / h; minLambda = c / maxF; maxLambda = c / minF; minWavenumber = minF / c; maxWavenumber = maxF / c;
        }
        document.getElementById('range-f-min').textContent = (minF / parseFloat(fTabRangeFOutputSelect.value)).toPrecision(7); document.getElementById('range-f-max').textContent = (maxF / parseFloat(fTabRangeFOutputSelect.value)).toPrecision(7);
        document.getElementById('range-lambda-min').textContent = (minLambda / parseFloat(fTabRangeLambdaOutputSelect.value)).toPrecision(7); document.getElementById('range-lambda-max').textContent = (maxLambda / parseFloat(fTabRangeLambdaOutputSelect.value)).toPrecision(7);
        document.getElementById('range-wavenumber-min').textContent = (minWavenumber / parseFloat(fTabRangeWavenumberOutputSelect.value)).toPrecision(7); document.getElementById('range-wavenumber-max').textContent = (maxWavenumber / parseFloat(fTabRangeWavenumberOutputSelect.value)).toPrecision(7);
        document.getElementById('range-e-min').textContent = ((minE_joule * eV_per_Joule) / parseFloat(fTabRangeEOutputSelect.value)).toPrecision(7); document.getElementById('range-e-max').textContent = ((maxE_joule * eV_per_Joule) / parseFloat(fTabRangeEOutputSelect.value)).toPrecision(7);
    }
    // ...

    // 初期化
    document.addEventListener("DOMContentLoaded", function() {
        // KaTeX初期化
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });

        // タブ切り替え機能
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                contents.forEach(c => c.classList.remove('active'));
                const target = document.getElementById(tab.dataset.tab);
                target.classList.add('active');
                
                if (tab.dataset.tab === 'tab2') {
                    // タブ2に切り替えたらグラフの入力フィールドを更新
                    updateGraphInputFields();
                }
            });
        });

        // 周波数タブの初期化
        fTabInputTypeRadios.forEach(radio => radio.addEventListener('change', () => {
            const selectedType = document.querySelector('#tab1 input[name="input-type"]:checked').value;
            populateScales(fTabInputScaleSelect, selectedType, units[selectedType].default);
            updateSliderRange();
            calculateSingleValue();
        }));
        fTabInputValue.addEventListener('input', updateSliderRange);
        fTabInputValue.addEventListener('input', calculateSingleValue);
        fTabInputScaleSelect.addEventListener('change', calculateSingleValue);
        fTabSlider.addEventListener('input', handleSliderInput);
        populateScales(fOutputSelect, 'f', units.f.default);
        populateScales(lambdaOutputSelect, 'lambda', units.lambda.default);
        populateScales(wavenumberOutputSelect, 'wavenumber', units.wavenumber.default);
        populateScales(eOutputSelect, 'e', units.e.default);
        fOutputSelect.addEventListener('change', calculateSingleValue);
        lambdaOutputSelect.addEventListener('change', calculateSingleValue);
        wavenumberOutputSelect.addEventListener('change', calculateSingleValue);
        eOutputSelect.addEventListener('change', calculateSingleValue);
        
        fTabRangeTypeRadios.forEach(radio => radio.addEventListener('change', () => {
            const selectedType = document.querySelector('#tab1 input[name="range-type"]:checked').value;
            populateScales(fTabRangeScaleSelect, selectedType, units[selectedType].default);
            calculateRange();
        }));
        fTabMinInput.addEventListener('input', calculateRange);
        fTabMaxInput.addEventListener('input', calculateRange);
        fTabRangeScaleSelect.addEventListener('change', calculateRange);
        
        populateScales(fTabRangeFOutputSelect, 'f', units.f.default);
        populateScales(fTabRangeLambdaOutputSelect, 'lambda', units.lambda.default);
        populateScales(fTabRangeWavenumberOutputSelect, 'wavenumber', units.wavenumber.default);
        populateScales(fTabRangeEOutputSelect, 'e', units.e.default);
        fTabRangeFOutputSelect.addEventListener('change', calculateRange);
        fTabRangeLambdaOutputSelect.addEventListener('change', calculateRange);
        fTabRangeWavenumberOutputSelect.addEventListener('change', calculateRange);
        fTabRangeEOutputSelect.addEventListener('change', calculateRange);
        
        updateSingleInputScales();
        updateRangeInputScales();
        
        // 複素数タブの初期化
        complexInputTypeRadios.forEach(radio => radio.addEventListener('change', updateComplexInputs));
        nInput.addEventListener('input', calculateComplex);
        kInput.addEventListener('input', calculateComplex);
        eRealInput.addEventListener('input', calculateComplex);
        eImagInput.addEventListener('input', calculateComplex);
        
        // グラフ設定の初期化 (改善点1 & 2)
        graphXAxisRadios.forEach(radio => radio.addEventListener('change', updateGraphInputFields));
        minXAxisInput.addEventListener('input', calculateComplex);
        maxXAxisInput.addEventListener('input', calculateComplex);
        xAxisScaleSelect.addEventListener('change', calculateComplex);
        updateGraphButton.addEventListener('click', calculateComplex);

        // 改善点2: 縦軸単位の初期化とイベントリスナー設定
        populateScales(yAxisScaleSelect, 'alpha', units.alpha.default);
        yAxisScaleSelect.addEventListener('change', calculateComplex);

        // 初期表示
        updateComplexInputs(); 
        updateGraphInputFields();
    });
</script>

</body>
</html>